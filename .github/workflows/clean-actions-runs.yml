name: Clean Failed GitHub Actions Runs

# è§¦å‘æ–¹å¼ï¼š
# 1. æ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èï¼‰ï¼šåœ¨ Actions é¡µé¢ç‚¹ "Run workflow"
# 2. å¯é€‰ï¼šå®šæ—¶è§¦å‘ï¼ˆæ¯”å¦‚æ¯å‘¨æ—¥å‡Œæ™¨ï¼‰ï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Šå³å¯
# on:
#   workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
#   schedule:
#     - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥ 0 ç‚¹æ‰§è¡Œ

on: workflow_dispatch  # ä»…ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼Œé¿å…è¯¯æ“ä½œ

permissions:
  # å¿…é¡»æˆäºˆè¶³å¤Ÿçš„æƒé™æ‰èƒ½åˆ é™¤ Actions è®°å½•
  actions: write
  contents: read

jobs:
  clean-failed-runs:
    runs-on: ubuntu-latest
    steps:
      - name: Delete only failed GitHub Actions runs
        env:
          # ä½¿ç”¨ GitHub å†…ç½®ä»¤ç‰Œï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # è‡ªåŠ¨è·å–ä»“åº“æ‰€æœ‰è€…å’Œä»“åº“åï¼Œæ— éœ€æ‰‹åŠ¨ä¿®æ”¹
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          # å®‰è£… jq ç”¨äº JSON è§£æ
          sudo apt-get update && sudo apt-get install -y jq

          # åˆ†é¡µè·å–æ‰€æœ‰è¿è¡Œè®°å½•ï¼Œåªç­›é€‰å¤±è´¥çš„
          page=1
          deleted_count=0
          while true; do
            echo "ğŸ“„ è·å–ç¬¬ $page é¡µçš„è¿è¡Œè®°å½•..."
            # è°ƒç”¨ API è·å–å½“å‰é¡µè®°å½•ï¼ˆæ¯é¡µ 100 æ¡ï¼Œæœ€å¤§åˆ†é¡µé‡ï¼‰
            runs=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$OWNER/$REPO/actions/runs?page=$page&per_page=100")
          
            # æå–ã€Œå·²å®Œæˆä¸”æ‰§è¡Œå¤±è´¥ã€çš„è®°å½• ID
            # çŠ¶æ€è¯´æ˜ï¼š
            # - status: completed = è¿è¡Œå·²ç»“æŸï¼ˆæ’é™¤ running/queued çŠ¶æ€ï¼‰
            # - conclusion: failure = æ‰§è¡Œå¤±è´¥ï¼ˆå…¶ä»–å€¼ï¼šsuccess/cancelled/skipped ç­‰ï¼‰
            failed_run_ids=$(echo "$runs" | jq -r '
              .workflow_runs[] | 
              select(.status == "completed" and .conclusion == "failure") | 
              .id
            ')

            # å¦‚æœå½“å‰é¡µæ— å¤±è´¥è®°å½•ï¼Œé€€å‡ºå¾ªç¯
            if [ -z "$failed_run_ids" ] || [ "$failed_run_ids" = "null" ]; then
              echo "âœ… ç¬¬ $page é¡µæ— å¤±è´¥è®°å½•ï¼Œç»“æŸåˆ†é¡µæŸ¥è¯¢"
              break
            fi

            # å¾ªç¯åˆ é™¤æ¯æ¡å¤±è´¥è®°å½•
            for id in $failed_run_ids; do
              echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤å¤±è´¥è®°å½• ID: $id"
              # å‘é€åˆ é™¤è¯·æ±‚ï¼Œå¿½ç•¥å•ä¸ªå¤±è´¥ï¼ˆé¿å…å½±å“æ•´ä½“ï¼‰
              curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/repos/$OWNER/$REPO/actions/runs/$id"
              deleted_count=$((deleted_count + 1))
              sleep 0.5  # é™ä½ API è°ƒç”¨é¢‘ç‡
            done

            page=$((page + 1))
          done

          echo "ğŸ‰ æ¸…ç†å®Œæˆï¼å…±åˆ é™¤ $deleted_count æ¡å¤±è´¥çš„ Actions è¿è¡Œè®°å½•"
